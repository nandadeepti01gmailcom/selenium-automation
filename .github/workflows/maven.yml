name: Java CI - Maven Tests
 on:
  workflow_dispatch: {}
  # Manual dispatch allows running the workflow from GitHub UI or `gh` CLI
  
  push:
    # Run CI on push to any branch
    branches: ['**']
    # Run on semantic or release tags (e.g. v1.2.3 or release-2026-01-01)
    tags: [ 'v*', 'release-*' ]
  pull_request:
    branches: [ main, master ]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Set up JDK 8
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '8'

    - name: Cache Maven packages
      uses: actions/cache@v4
      with:
        path: ~/.m2/repository
        key: ${{ runner.os }}-maven-${{ hashFiles('**/pom.xml') }}
        restore-keys: |
          ${{ runner.os }}-maven-

    - name: Build and run tests
      run: mvn -B test

    - name: Upload test reports
      if: always()
      uses: actions/upload-artifact@v4
      with:
        # Include the tag name when triggered by a tag; otherwise branch name
        name: test-reports-${{ github.ref_name }}-${{ github.run_id }}
        path: |
          test-reports
          target/surefire-reports

    - name: Print test report files (for quick debug)
      if: always()
      run: |
        echo "--- test-reports contents ---"
        ls -la test-reports || true
        echo "--- surefire-reports contents ---"
        ls -la target/surefire-reports || true

    - name: Notify Slack (optional)
      if: ${{ secrets.SLACK_WEBHOOK }}
      uses: slackapi/slack-github-action@v1.23.0
      with:
        payload: |
          {
            "text": "*CI Report*: <https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}|View Run>",
            "attachments": [
              {
                "color": "${{ job.status == 'success' && '#36a64f' || '#ff0000' }}",
                "fields": [
                  {"title": "Repository", "value": "${{ github.repository }}", "short": true},
                  {"title": "Ref", "value": "${{ github.ref_name }}", "short": true},
                  {"title": "Status", "value": "${{ job.status }}", "short": true}
                ]
              }
            ]
          }
      env:
        SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK }}

    - name: Prepare release artifacts (zip reports)
      if: startsWith(github.ref, 'refs/tags/')
      run: |
        echo "Zipping test reports for release: ${{ github.ref_name }}"
        mkdir -p release-artifacts || true
        ZIP_NAME=release-artifacts/test-reports-${{ github.ref_name }}.zip
        if [ -d test-reports ]; then
          zip -r "$ZIP_NAME" test-reports || true
        fi
        if [ -d target/surefire-reports ]; then
          zip -r "$ZIP_NAME" target/surefire-reports || true
        fi

    - name: Create GitHub Release (on tag)
      if: startsWith(github.ref, 'refs/tags/')
      id: create_release
      uses: actions/create-release@v1
      with:
        tag_name: ${{ github.ref_name }}
        release_name: Release ${{ github.ref_name }}
        body: |
          Automated test reports for ${{ github.ref_name }}
        draft: false
        prerelease: false
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: Upload test reports to Release
      if: startsWith(github.ref, 'refs/tags/')
      uses: actions/upload-release-asset@v1
      with:
        upload_url: ${{ steps.create_release.outputs.upload_url }}
        asset_path: release-artifacts/test-reports-${{ github.ref_name }}.zip
        asset_name: test-reports-${{ github.ref_name }}.zip
        asset_content_type: application/zip
