name: Run Tests by Tags

# Manual workflow to run specific test suites based on tags
# Allows flexible test execution with custom tag combinations

on:
  workflow_dispatch:
    inputs:
      test_suite:
        description: 'Select Test Suite'
        required: true
        type: choice
        options:
          - 'smoke'
          - 'regression'
          - 'sanity'
          - 'all'
          - 'custom'
        default: 'smoke'
        push:   # ADD THIS - temporary trigger
    branches:
      - feature/selenium
      include_tags:
        description: 'Tags to include (for custom suite, e.g., "smoke & login" or "p0 | p1")'
        required: false
        type: string
        default: ''
      
      exclude_tags:
        description: 'Tags to exclude (e.g., "wip,slow")'
        required: false
        type: string
        default: 'wip'
      
      environment:
        description: 'Test Environment'
        required: true
        type: choice
        options:
          - 'dev'
          - 'staging'
          - 'prod'
        default: 'dev'
      
      browser:
        description: 'Browser for testing'
        required: false
        type: choice
        options:
          - 'chrome'
          - 'firefox'
          - 'edge'
        default: 'chrome'
      
      send_slack_notification:
        description: 'Send results to Slack'
        required: false
        type: boolean
        default: true

jobs:
  test-execution:
    runs-on: ubuntu-latest
    
    env:
      TEST_ENVIRONMENT: ${{ inputs.environment }}
      BROWSER: ${{ inputs.browser }}

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Set up JDK 8
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '8'

    - name: Cache Maven packages
      uses: actions/cache@v4
      with:
        path: ~/.m2/repository
        key: ${{ runner.os }}-maven-${{ hashFiles('**/pom.xml') }}
        restore-keys: |
          ${{ runner.os }}-maven-

    - name: Display test execution parameters
      run: |
        echo "=========================================="
        echo "Test Execution Configuration"
        echo "=========================================="
        echo "Test Suite: ${{ inputs.test_suite }}"
        echo "Environment: ${{ inputs.environment }}"
        echo "Browser: ${{ inputs.browser }}"
        echo "Include Tags: ${{ inputs.include_tags }}"
        echo "Exclude Tags: ${{ inputs.exclude_tags }}"
        echo "Slack Notification: ${{ inputs.send_slack_notification }}"
        echo "=========================================="

    - name: Build project
      run: mvn clean compile

    - name: Run Smoke Tests
      if: inputs.test_suite == 'smoke'
      run: |
        echo "Running Smoke Tests..."
        mvn test -DincludeTags=smoke -DexcludeTags=${{ inputs.exclude_tags }}
      continue-on-error: true

    - name: Run Regression Tests
      if: inputs.test_suite == 'regression'
      run: |
        echo "Running Regression Tests..."
        mvn test -DincludeTags=regression -DexcludeTags=${{ inputs.exclude_tags }}
      continue-on-error: true

    - name: Run Sanity Tests
      if: inputs.test_suite == 'sanity'
      run: |
        echo "Running Sanity Tests..."
        mvn test -DincludeTags=sanity -DexcludeTags=${{ inputs.exclude_tags }}
      continue-on-error: true

    - name: Run All Tests
      if: inputs.test_suite == 'all'
      run: |
        echo "Running All Tests..."
        mvn test -DexcludeTags=${{ inputs.exclude_tags }}
      continue-on-error: true

    - name: Run Custom Tag Tests
      if: inputs.test_suite == 'custom'
      run: |
        echo "Running Custom Tag Tests..."
        if [ -n "${{ inputs.include_tags }}" ]; then
          mvn test -DincludeTags="${{ inputs.include_tags }}" -DexcludeTags=${{ inputs.exclude_tags }}
        else
          echo "Error: include_tags is required for custom test suite"
          exit 1
        fi
      continue-on-error: true

    - name: Generate test summary
      if: always()
      run: |
        echo "## Test Execution Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Test Suite:** ${{ inputs.test_suite }}" >> $GITHUB_STEP_SUMMARY
        echo "**Environment:** ${{ inputs.environment }}" >> $GITHUB_STEP_SUMMARY
        echo "**Browser:** ${{ inputs.browser }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        if [ -d "target/surefire-reports" ]; then
          echo "### Test Results" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          find target/surefire-reports -name "*.txt" -exec cat {} \; >> $GITHUB_STEP_SUMMARY || true
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
        fi

    - name: Upload test reports
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: test-reports-${{ inputs.test_suite }}-${{ inputs.environment }}-${{ github.run_id }}
        path: |
          test-reports/**/*.html
          target/surefire-reports/**/*
        retention-days: 30

    - name: Check test results
      if: always()
      id: test_results
      run: |
        if [ -d "target/surefire-reports" ]; then
          TOTAL=$(find target/surefire-reports -name "TEST-*.xml" -exec grep -c '<testsuite' {} + | awk '{s+=$1} END {print s}')
          FAILURES=$(find target/surefire-reports -name "TEST-*.xml" -exec grep -oP 'failures="\K[0-9]+' {} + | awk '{s+=$1} END {print s}')
          ERRORS=$(find target/surefire-reports -name "TEST-*.xml" -exec grep -oP 'errors="\K[0-9]+' {} + | awk '{s+=$1} END {print s}')
          SKIPPED=$(find target/surefire-reports -name "TEST-*.xml" -exec grep -oP 'skipped="\K[0-9]+' {} + | awk '{s+=$1} END {print s}')
          
          PASSED=$((TOTAL - FAILURES - ERRORS - SKIPPED))
          
          echo "total=$TOTAL" >> $GITHUB_OUTPUT
          echo "passed=$PASSED" >> $GITHUB_OUTPUT
          echo "failed=$((FAILURES + ERRORS))" >> $GITHUB_OUTPUT
          echo "skipped=$SKIPPED" >> $GITHUB_OUTPUT
          
          if [ $((FAILURES + ERRORS)) -gt 0 ]; then
            echo "status=failed" >> $GITHUB_OUTPUT
          else
            echo "status=passed" >> $GITHUB_OUTPUT
          fi
        else
          echo "status=unknown" >> $GITHUB_OUTPUT
          echo "No test results found"
        fi

    - name: Send Slack notification
      if: always() && inputs.send_slack_notification && secrets.SLACK_WEBHOOK_URL
      uses: slackapi/slack-github-action@v1.26.0
      with:
        payload: |
          {
            "text": "${{ steps.test_results.outputs.status == 'passed' && '✅' || '❌' }} Test Execution ${{ steps.test_results.outputs.status == 'passed' && 'PASSED' || 'FAILED' }}",
            "blocks": [
              {
                "type": "header",
                "text": {
                  "type": "plain_text",
                  "text": "${{ steps.test_results.outputs.status == 'passed' && '✅' || '❌' }} Test Results - ${{ inputs.test_suite }}"
                }
              },
              {
                "type": "section",
                "fields": [
                  {
                    "type": "mrkdwn",
                    "text": "*Test Suite:*\n${{ inputs.test_suite }}"
                  },
                  {
                    "type": "mrkdwn",
                    "text": "*Environment:*\n${{ inputs.environment }}"
                  },
                  {
                    "type": "mrkdwn",
                    "text": "*Browser:*\n${{ inputs.browser }}"
                  },
                  {
                    "type": "mrkdwn",
                    "text": "*Status:*\n${{ steps.test_results.outputs.status }}"
                  }
                ]
              },
              {
                "type": "section",
                "fields": [
                  {
                    "type": "mrkdwn",
                    "text": "*Total:* ${{ steps.test_results.outputs.total || '0' }}"
                  },
                  {
                    "type": "mrkdwn",
                    "text": "*Passed:* ${{ steps.test_results.outputs.passed || '0' }}"
                  },
                  {
                    "type": "mrkdwn",
                    "text": "*Failed:* ${{ steps.test_results.outputs.failed || '0' }}"
                  },
                  {
                    "type": "mrkdwn",
                    "text": "*Skipped:* ${{ steps.test_results.outputs.skipped || '0' }}"
                  }
                ]
              },
              {
                "type": "section",
                "text": {
                  "type": "mrkdwn",
                  "text": "*Triggered by:* ${{ github.actor }}\n*Repository:* ${{ github.repository }}\n*Branch:* ${{ github.ref_name }}"
                }
              },
              {
                "type": "actions",
                "elements": [
                  {
                    "type": "button",
                    "text": {
                      "type": "plain_text",
                      "text": "View Run"
                    },
                    "url": "https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
                  }
                ]
              }
            ]
          }
      env:
        SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

    - name: Fail workflow if tests failed
      if: always() && steps.test_results.outputs.status == 'failed'
      run: |
        echo "Tests failed. Marking workflow as failed."
        exit 1
