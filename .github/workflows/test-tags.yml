name: Execute Tests by Tags

# Manual workflow to run specific test suites based on tags
# Allows flexible test execution with custom tag combinations
# Automated scheduled runs at 5:10 AM UTC daily (10:40 AM IST)

on:
  push:
    branches:
      - feature/selenium
      - main
    paths:
      - 'src/**'
      - 'pom.xml'
      - '.github/workflows/test-tags.yml'
  
  schedule:
    # Runs daily at 5:10 AM UTC (10:40 AM IST)
    # Cron format: minute hour day-of-month month day-of-week
    - cron: '10 5 * * *'
  
  workflow_dispatch:
    inputs:
      test_suite:
        description: 'Select Test Suite'
        required: true
        type: choice
        options:
          - 'smoke'
          - 'regression'
          - 'sanity'
          - 'all'
          - 'custom'
        default: 'smoke'
      
      include_tags:
        description: 'Tags to include (for custom suite, e.g., "smoke & login" or "p0 | p1")'
        required: false
        type: string
        default: ''
      
      exclude_tags:
        description: 'Tags to exclude (e.g., "wip,slow")'
        required: false
        type: string
        default: 'wip'
      
      environment:
        description: 'Test Environment'
        required: true
        type: choice
        options:
          - 'dev'
          - 'staging'
          - 'prod'
        default: 'dev'
      
      browser:
        description: 'Browser for testing'
        required: false
        type: choice
        options:
          - 'chrome'
          - 'firefox'
          - 'edge'
        default: 'chrome'
      
      send_slack_notification:
        description: 'Send results to Slack'
        required: false
        type: boolean
        default: true

jobs:
  test-execution:
    runs-on: ubuntu-latest
    
    env:
      # For scheduled runs, use defaults; for manual runs, use inputs
      TEST_SUITE: ${{ inputs.test_suite || 'regression' }}
      INCLUDE_TAGS: ${{ inputs.include_tags || '' }}
      EXCLUDE_TAGS: ${{ inputs.exclude_tags || 'wip' }}
      TEST_ENVIRONMENT: ${{ inputs.environment || 'dev' }}
      BROWSER: ${{ inputs.browser || 'chrome' }}
      SEND_SLACK: ${{ inputs.send_slack_notification == true || github.event_name == 'schedule' }}

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Set up JDK 11
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '11'

    - name: Cache Maven packages
      uses: actions/cache@v4
      with:
        path: ~/.m2/repository
        key: ${{ runner.os }}-maven-${{ hashFiles('**/pom.xml') }}
        restore-keys: |
          ${{ runner.os }}-maven-

    - name: Display test execution parameters
      run: |
        echo "=========================================="
        echo "Test Execution Configuration"
        echo "=========================================="
        echo "Trigger: ${{ github.event_name }}"
        echo "Test Suite: ${{ env.TEST_SUITE }}"
        echo "Environment: ${{ env.TEST_ENVIRONMENT }}"
        echo "Browser: ${{ env.BROWSER }}"
        echo "Include Tags: ${{ env.INCLUDE_TAGS }}"
        echo "Exclude Tags: ${{ env.EXCLUDE_TAGS }}"
        echo "Slack Notification: ${{ env.SEND_SLACK }}"
        if [ "${{ github.event_name }}" == "schedule" ]; then
          echo "NOTE: This is an automated scheduled run (5:10 AM UTC / 10:40 AM IST daily)"
        fi
        echo "=========================================="

    - name: Build project
      run: mvn clean compile

    - name: Run Smoke Tests
      if: env.TEST_SUITE == 'smoke'
      run: |
        echo "Running Smoke Tests..."
        mvn test -DincludeTags=smoke -DexcludeTags=${{ env.EXCLUDE_TAGS }}
      continue-on-error: true

    - name: Run Regression Tests
      if: env.TEST_SUITE == 'regression'
      run: |
        echo "Running Regression Tests..."
        mvn test -DincludeTags=regression -DexcludeTags=${{ env.EXCLUDE_TAGS }}
      continue-on-error: true

    - name: Run Sanity Tests
      if: env.TEST_SUITE == 'sanity'
      run: |
        echo "Running Sanity Tests..."
        mvn test -DincludeTags=sanity -DexcludeTags=${{ env.EXCLUDE_TAGS }}
      continue-on-error: true

    - name: Run All Tests
      if: env.TEST_SUITE == 'all'
      run: |
        echo "Running All Tests..."
        mvn test -DexcludeTags=${{ env.EXCLUDE_TAGS }}
      continue-on-error: true

    - name: Run Custom Tag Tests
      if: env.TEST_SUITE == 'custom'
      run: |
        echo "Running Custom Tag Tests..."
        if [ -n "${{ env.INCLUDE_TAGS }}" ]; then
          mvn test -DincludeTags="${{ env.INCLUDE_TAGS }}" -DexcludeTags=${{ env.EXCLUDE_TAGS }}
        else
          echo "Error: include_tags is required for custom test suite"
          exit 1
        fi
      continue-on-error: true

    - name: Generate test summary
      if: always()
      run: |
        echo "## Test Execution Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Trigger:** ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
        echo "**Test Suite:** ${{ env.TEST_SUITE }}" >> $GITHUB_STEP_SUMMARY
        echo "**Environment:** ${{ env.TEST_ENVIRONMENT }}" >> $GITHUB_STEP_SUMMARY
        echo "**Browser:** ${{ env.BROWSER }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        if [ -d "target/surefire-reports" ]; then
          echo "### Test Results" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          find target/surefire-reports -name "*.txt" -exec cat {} \; >> $GITHUB_STEP_SUMMARY || true
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          
          # Parse XML files for detailed test information
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### üìä Detailed Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          for xmlfile in target/surefire-reports/TEST-*.xml; do
            if [ -f "$xmlfile" ]; then
              # Extract test suite name
              SUITE_NAME=$(basename "$xmlfile" .xml | sed 's/TEST-//')
              echo "#### Test Suite: \`$SUITE_NAME\`" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              
              # Parse XML using xmllint and grep
              TESTS=$(grep -oP 'tests="\K[0-9]+' "$xmlfile" | head -1)
              FAILURES=$(grep -oP 'failures="\K[0-9]+' "$xmlfile" | head -1)
              ERRORS=$(grep -oP 'errors="\K[0-9]+' "$xmlfile" | head -1)
              SKIPPED=$(grep -oP 'skipped="\K[0-9]+' "$xmlfile" | head -1)
              PASSED=$((TESTS - FAILURES - ERRORS - SKIPPED))
              
              echo "| Metric | Count |" >> $GITHUB_STEP_SUMMARY
              echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
              echo "| Total Tests | $TESTS |" >> $GITHUB_STEP_SUMMARY
              echo "| ‚úÖ Passed | $PASSED |" >> $GITHUB_STEP_SUMMARY
              echo "| ‚ùå Failed | $FAILURES |" >> $GITHUB_STEP_SUMMARY
              echo "| ‚ö†Ô∏è Errors | $ERRORS |" >> $GITHUB_STEP_SUMMARY
              echo "| ‚è≠Ô∏è Skipped | $SKIPPED |" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              
              # Extract failed test cases with failure reasons
              if [ $FAILURES -gt 0 ] || [ $ERRORS -gt 0 ]; then
                echo "<details><summary>‚ùå Failed Test Details</summary>" >> $GITHUB_STEP_SUMMARY
                echo "" >> $GITHUB_STEP_SUMMARY
                
                # Use grep and awk to extract failure information
                grep -A 2 '<failure\|<error' "$xmlfile" | while IFS= read -r line; do
                  if [[ "$line" =~ testcase.*name=\"([^\"]+)\" ]]; then
                    TEST_NAME="${BASH_REMATCH[1]}"
                    echo "**Test:** \`$TEST_NAME\`" >> $GITHUB_STEP_SUMMARY
                  elif [[ "$line" =~ message=\"([^\"]+)\" ]]; then
                    FAILURE_MSG="${BASH_REMATCH[1]}"
                    echo "**Reason:** $FAILURE_MSG" >> $GITHUB_STEP_SUMMARY
                    echo "" >> $GITHUB_STEP_SUMMARY
                  fi
                done || true
                
                echo "</details>" >> $GITHUB_STEP_SUMMARY
                echo "" >> $GITHUB_STEP_SUMMARY
              fi
            fi
          done
        fi
        
        # Check for failure screenshots
        if [ -d "test-reports/screenshots" ]; then
          SCREENSHOT_COUNT=$(find test-reports/screenshots -type f -name "*.png" 2>/dev/null | wc -l)
          if [ "$SCREENSHOT_COUNT" -gt 0 ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### üì∏ Failure Screenshots" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**$SCREENSHOT_COUNT screenshot(s) captured for failed test cases**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Screenshots are available in the artifacts:" >> $GITHUB_STEP_SUMMARY
            echo "- Download 'failure-screenshots' artifact from the workflow run" >> $GITHUB_STEP_SUMMARY
            echo "- Or check 'test-reports' artifact (includes all reports + screenshots)" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "<details><summary>Screenshot Files</summary>" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            find test-reports/screenshots -type f -name "*.png" -exec basename {} \; >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            echo "</details>" >> $GITHUB_STEP_SUMMARY
          fi
        fi

    - name: Upload test reports
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: test-reports-${{ env.TEST_SUITE }}-${{ env.TEST_ENVIRONMENT }}-${{ github.run_id }}
        path: |
          test-reports/**/*.html
          test-reports/screenshots/**/*
          target/surefire-reports/**/*
        retention-days: 30

    - name: Upload failure screenshots
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: failure-screenshots-${{ env.TEST_SUITE }}-${{ env.TEST_ENVIRONMENT }}-${{ github.run_id }}
        path: test-reports/screenshots/**/*
        if-no-files-found: ignore
        retention-days: 30

    - name: Check test results
      if: always()
      id: test_results
      run: |
        if [ -d "target/surefire-reports" ]; then
          TOTAL=$(find target/surefire-reports -name "TEST-*.xml" -exec grep -c '<testsuite' {} + | awk '{s+=$1} END {print s}')
          FAILURES=$(find target/surefire-reports -name "TEST-*.xml" -exec grep -oP 'failures="\K[0-9]+' {} + | awk '{s+=$1} END {print s}')
          ERRORS=$(find target/surefire-reports -name "TEST-*.xml" -exec grep -oP 'errors="\K[0-9]+' {} + | awk '{s+=$1} END {print s}')
          SKIPPED=$(find target/surefire-reports -name "TEST-*.xml" -exec grep -oP 'skipped="\K[0-9]+' {} + | awk '{s+=$1} END {print s}')
          
          PASSED=$((TOTAL - FAILURES - ERRORS - SKIPPED))
          
          echo "total=$TOTAL" >> $GITHUB_OUTPUT
          echo "passed=$PASSED" >> $GITHUB_OUTPUT
          echo "failed=$((FAILURES + ERRORS))" >> $GITHUB_OUTPUT
          echo "skipped=$SKIPPED" >> $GITHUB_OUTPUT
          
          if [ $((FAILURES + ERRORS)) -gt 0 ]; then
            echo "status=failed" >> $GITHUB_OUTPUT
          else
            echo "status=passed" >> $GITHUB_OUTPUT
          fi
        else
          echo "status=unknown" >> $GITHUB_OUTPUT
          echo "No test results found"
        fi

    - name: Count failure screenshots
      if: always()
      id: screenshot_count
      run: |
        if [ -d "test-reports/screenshots" ]; then
          COUNT=$(find test-reports/screenshots -type f -name "*.png" 2>/dev/null | wc -l)
          echo "count=$COUNT" >> $GITHUB_OUTPUT
          echo "üì∏ Found $COUNT failure screenshot(s)"
        else
          echo "count=0" >> $GITHUB_OUTPUT
          echo "No screenshots directory found"
        fi

    - name: Check Slack configuration
      if: always() && env.SEND_SLACK == 'true'
      run: |
        if [ -z "${{ secrets.SLACK_WEBHOOK_URL }}" ]; then
          echo "‚ö†Ô∏è  WARNING: Slack notifications enabled but SLACK_WEBHOOK_URL secret is not configured"
          echo "‚ÑπÔ∏è  To enable Slack notifications, add SLACK_WEBHOOK_URL to your GitHub repository secrets"
          echo "‚ÑπÔ∏è  Go to: Settings > Secrets and variables > Actions > New repository secret"
        else
          echo "‚úÖ Slack webhook configured"
        fi

    - name: Send Slack notification
      if: always() && env.SEND_SLACK == 'true'
      continue-on-error: true
      uses: slackapi/slack-github-action@v1.26.0
      with:
        webhook-url: ${{ secrets.SLACK_WEBHOOK_URL }}
        payload: |
          {
            "text": "${{ steps.test_results.outputs.status == 'passed' && '‚úÖ' || '‚ùå' }} Test Execution ${{ steps.test_results.outputs.status == 'passed' && 'PASSED' || 'FAILED' }}",
            "blocks": [
              {
                "type": "header",
                "text": {
                  "type": "plain_text",
                  "text": "${{ steps.test_results.outputs.status == 'passed' && '‚úÖ' || '‚ùå' }} Test Results - ${{ env.TEST_SUITE }}"
                }
              },
              {
                "type": "section",
                "fields": [
                  {
                    "type": "mrkdwn",
                    "text": "*Test Suite:*\n${{ env.TEST_SUITE }}"
                  },
                  {
                    "type": "mrkdwn",
                    "text": "*Environment:*\n${{ env.TEST_ENVIRONMENT }}"
                  },
                  {
                    "type": "mrkdwn",
                    "text": "*Browser:*\n${{ env.BROWSER }}"
                  },
                  {
                    "type": "mrkdwn",
                    "text": "*Status:*\n${{ steps.test_results.outputs.status }}"
                  }
                ]
              },
              {
                "type": "section",
                "fields": [
                  {
                    "type": "mrkdwn",
                    "text": "*Total:* ${{ steps.test_results.outputs.total || '0' }}"
                  },
                  {
                    "type": "mrkdwn",
                    "text": "*Passed:* ${{ steps.test_results.outputs.passed || '0' }}"
                  },
                  {
                    "type": "mrkdwn",
                    "text": "*Failed:* ${{ steps.test_results.outputs.failed || '0' }}"
                  },
                  {
                    "type": "mrkdwn",
                    "text": "*Skipped:* ${{ steps.test_results.outputs.skipped || '0' }}"
                  }
                ]
              },
              {
                "type": "divider"
              },
              {
                "type": "section",
                "text": {
                  "type": "mrkdwn",
                  "text": "*üìã Test Execution Summary*\n\n*Trigger:* ${{ github.event_name }}\n*Test Suite:* ${{ env.TEST_SUITE }}\n*Environment:* ${{ env.TEST_ENVIRONMENT }}\n*Browser:* ${{ env.BROWSER }}"
                }
              },
              {
                "type": "section",
                "text": {
                  "type": "mrkdwn",
                  "text": "*üîó Workflow Details*\n\n*Triggered by:* ${{ github.actor }}\n*Repository:* ${{ github.repository }}\n*Branch:* ${{ github.ref_name }}\n*Run Number:* #${{ github.run_number }}\n*Workflow URL:* ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
                }
              },
              {
                "type": "divider"
              },
              {
                "type": "section",
                "text": {
                  "type": "mrkdwn",
                  "text": "${{ steps.screenshot_count.outputs.count > 0 && format('*üì∏ Failure Screenshots*\n\n*{0} screenshot(s)* captured for failed test cases\n\nScreenshots are available in the artifacts:\n‚Ä¢ Download `failure-screenshots` artifact from the workflow run\n‚Ä¢ Or check `test-reports` artifact (includes all reports + screenshots)', steps.screenshot_count.outputs.count) || '*‚úÖ No Failures*\n\nAll tests passed - No screenshots captured' }}"
                }
              },
              {
                "type": "actions",
                "elements": [
                  {
                    "type": "button",
                    "text": {
                      "type": "plain_text",
                      "text": "View Full Report"
                    },
                    "url": "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
                  }
                ]
              }
            ]
          }
      env:
        SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

    - name: Fail workflow if tests failed
      if: always() && steps.test_results.outputs.status == 'failed'
      run: |
        echo "Tests failed. Marking workflow as failed."
        exit 1
